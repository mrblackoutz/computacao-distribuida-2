# Arquitetura do Sistema - SCTEC

## VisÃ£o Geral

O SCTEC Ã© um sistema distribuÃ­do composto por dois microserviÃ§os independentes que colaboram para garantir agendamentos justos e consistentes do telescÃ³pio espacial.

---

## 1. Componentes do Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE WEB                          â”‚
â”‚  (Navegador com Interface HTML/CSS/JavaScript)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTP REST
               â”‚ (Tempo sincronizado via Algoritmo de Cristian)
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SERVIÃ‡O DE AGENDAMENTO (Flask)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ API RESTful (8 endpoints)                          â”‚   â”‚
â”‚  â”‚ â€¢ LÃ³gica de negÃ³cio                                  â”‚   â”‚
â”‚  â”‚ â€¢ ValidaÃ§Ãµes e regras                                â”‚   â”‚
â”‚  â”‚ â€¢ Logging de aplicaÃ§Ã£o + auditoria                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                    â”‚
â”‚                         â”‚ SQLAlchemy ORM                     â”‚
â”‚                         â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         SQLite Database                              â”‚   â”‚
â”‚  â”‚  - Tabela: cientistas                                â”‚   â”‚
â”‚  â”‚  - Tabela: agendamentos                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ HTTP POST /lock, /unlock
             â”‚ (CoordenaÃ§Ã£o distribuÃ­da)
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           SERVIÃ‡O COORDENADOR (Node.js/Express)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ Gerenciamento de locks (in-memory Map)             â”‚   â”‚
â”‚  â”‚ â€¢ ExclusÃ£o mÃºtua centralizada                        â”‚   â”‚
â”‚  â”‚ â€¢ Auto-liberaÃ§Ã£o por timeout                         â”‚   â”‚
â”‚  â”‚ â€¢ Alta performance (event-driven)                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Diagrama de SequÃªncia - Agendamento Bem-Sucedido

```
Cliente        Flask API      Coordenador      Banco de Dados
  â”‚               â”‚                â”‚                   â”‚
  â”‚ 1. POST       â”‚                â”‚                   â”‚
  â”‚ /agendamentos â”‚                â”‚                   â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                   â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 2. Gerar       â”‚                   â”‚
  â”‚               â”‚ correlation_id â”‚                   â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 3. Log:        â”‚                   â”‚
  â”‚               â”‚ "RequisiÃ§Ã£o    â”‚                   â”‚
  â”‚               â”‚  recebida"     â”‚                   â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 4. Validar     â”‚                   â”‚
  â”‚               â”‚ dados          â”‚                   â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 5. POST /lock  â”‚                   â”‚
  â”‚               â”‚ (recurso)      â”‚                   â”‚
  â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚                â”‚ 6. Verificar      â”‚
  â”‚               â”‚                â”‚ disponibilidade   â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚                â”‚ 7. Travar recurso â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚                â”‚ 8. Log:           â”‚
  â”‚               â”‚                â”‚ "Lock concedido"  â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 9. 200 OK      â”‚                   â”‚
  â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 10. Log:       â”‚                   â”‚
  â”‚               â”‚ "Lock          â”‚                   â”‚
  â”‚               â”‚  adquirido"    â”‚                   â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 11. SELECT     â”‚                   â”‚
  â”‚               â”‚ (verificar     â”‚                   â”‚
  â”‚               â”‚  conflitos)    â”‚                   â”‚
  â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 12. Nenhum     â”‚                   â”‚
  â”‚               â”‚ conflito       â”‚                   â”‚
  â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 13. INSERT     â”‚                   â”‚
  â”‚               â”‚ agendamento    â”‚                   â”‚
  â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 14. ID = 123   â”‚                   â”‚
  â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 15. Log AUDIT: â”‚                   â”‚
  â”‚               â”‚ "AGENDAMENTO_  â”‚                   â”‚
  â”‚               â”‚  CRIADO"       â”‚                   â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 16. POST       â”‚                   â”‚
  â”‚               â”‚ /unlock        â”‚                   â”‚
  â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚                â”‚ 17. Liberar       â”‚
  â”‚               â”‚                â”‚ recurso           â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚               â”‚ 18. 200 OK     â”‚                   â”‚
  â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
  â”‚               â”‚                â”‚                   â”‚
  â”‚ 19. 201       â”‚                â”‚                   â”‚
  â”‚ Created +     â”‚                â”‚                   â”‚
  â”‚ HATEOAS       â”‚                â”‚                   â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                   â”‚
  â”‚               â”‚                â”‚                   â”‚
```

**Tempo total**: ~200-300ms

**Pontos crÃ­ticos**:
- **Linha 5-9**: AquisiÃ§Ã£o do lock (bloqueio)
- **Linha 11-14**: OperaÃ§Ã£o no banco (seÃ§Ã£o crÃ­tica)
- **Linha 16-18**: LiberaÃ§Ã£o do lock (sempre executado via try/finally)

---

## 3. Diagrama de SequÃªncia - CondiÃ§Ã£o de Corrida (2 RequisiÃ§Ãµes SimultÃ¢neas)

```
Cliente A      Cliente B      Flask API A    Flask API B    Coordenador    Banco
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚ POST          â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚ /agendamentos â”‚               â”‚               â”‚               â”‚           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚ POST          â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚ /agendamentos â”‚               â”‚               â”‚           â”‚
  â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚ POST /lock    â”‚               â”‚           â”‚
  â”‚               â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚ POST /lock    â”‚           â”‚
  â”‚               â”‚               â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚ Recurso   â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚ LIVRE     â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚ Trava A   â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚ 200 OK        â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚ Recurso   â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚ OCUPADO!  â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚ 409 Conflict  â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚ SELECT        â”‚               â”‚           â”‚
  â”‚               â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚ OK            â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚ INSERT        â”‚               â”‚           â”‚
  â”‚               â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚ POST /unlock  â”‚               â”‚           â”‚
  â”‚               â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚ 201 Created   â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚ Log: Falha    â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚ ao adquirir   â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚ lock          â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚ 409 Conflict  â”‚               â”‚               â”‚           â”‚
  â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚           â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚           â”‚
```

**Resultado**:
- **Cliente A**: âœ… 201 Created (venceu a corrida)
- **Cliente B**: âŒ 409 Conflict (perdeu a corrida)

**Por que funciona**:
1. Ambas as requisiÃ§Ãµes tentam adquirir lock **simultaneamente**
2. O Coordenador processa requests de forma **serial** (event loop do Node.js)
3. A **primeira** a chegar trava o recurso
4. A **segunda** recebe 409 instantaneamente (sem espera)

---

## 4. Diagrama de SequÃªncia - SEM Lock (Problema)

```
Cliente A      Cliente B      Flask API A    Flask API B    Banco de Dados
  â”‚               â”‚               â”‚               â”‚               â”‚
  â”‚ POST          â”‚               â”‚               â”‚               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚               â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚
  â”‚               â”‚ POST          â”‚               â”‚               â”‚
  â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚
  â”‚               â”‚               â”‚ SELECT        â”‚               â”‚
  â”‚               â”‚               â”‚ (conflitos)   â”‚               â”‚
  â”‚               â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚
  â”‚               â”‚               â”‚               â”‚ SELECT        â”‚
  â”‚               â”‚               â”‚               â”‚ (conflitos)   â”‚
  â”‚               â”‚               â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚
  â”‚               â”‚               â”‚ Nenhum        â”‚               â”‚
  â”‚               â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚               â”‚               â”‚               â”‚               â”‚
  â”‚               â”‚               â”‚               â”‚ Nenhum        â”‚
  â”‚               â”‚               â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚               â”‚               â”‚               â”‚               â”‚
  â”‚               â”‚               â”‚ INSERT        â”‚               â”‚
  â”‚               â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚
  â”‚               â”‚               â”‚               â”‚ INSERT        â”‚
  â”‚               â”‚               â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚
  â”‚ 201 Created   â”‚               â”‚               â”‚               â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚
  â”‚               â”‚ 201 Created   â”‚               â”‚               â”‚
  â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
  â”‚               â”‚               â”‚               â”‚               â”‚
```

**Resultado**: ğŸš¨ **CONDIÃ‡ÃƒO DE CORRIDA**
- Ambas requisiÃ§Ãµes recebem 201 Created
- Banco tem **2 agendamentos conflitantes** para o mesmo horÃ¡rio
- Sistema estÃ¡ **inconsistente**

---

## 5. SincronizaÃ§Ã£o de Tempo (Algoritmo de Cristian)

```
Cliente                          Servidor (Flask)
  â”‚                                    â”‚
  â”‚ 1. Capturar T0 = now()             â”‚
  â”‚                                    â”‚
  â”‚ 2. GET /api/v1/time                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                    â”‚
  â”‚                                    â”‚ 3. Ts = now()
  â”‚                                    â”‚
  â”‚ 4. Response: {                     â”‚
  â”‚    timestamp_utc: Ts               â”‚
  â”‚    }                               â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                    â”‚
  â”‚ 5. Capturar T1 = now()             â”‚
  â”‚                                    â”‚
  â”‚ 6. Calcular:                       â”‚
  â”‚    RTT = T1 - T0                   â”‚
  â”‚    LatÃªncia = RTT / 2              â”‚
  â”‚    Offset = (Ts + LatÃªncia) - T1   â”‚
  â”‚                                    â”‚
  â”‚ 7. Tempo sincronizado:             â”‚
  â”‚    now() + Offset                  â”‚
  â”‚                                    â”‚
```

**Exemplo numÃ©rico**:

```
T0 = 15:30:45.000 (cliente dispara requisiÃ§Ã£o)
Ts = 15:30:45.100 (servidor responde com seu tempo)
T1 = 15:30:45.200 (cliente recebe resposta)

RTT = 200ms
LatÃªncia estimada = 100ms
Tempo do servidor ajustado = 15:30:45.100 + 100ms = 15:30:45.200
Offset = 15:30:45.200 - 15:30:45.200 = 0ms

Tempo sincronizado do cliente = now() + 0ms
```

**Se o relÃ³gio do cliente estiver 2s adiantado**:

```
T0 = 15:30:47.000 (cliente, 2s adiantado)
Ts = 15:30:45.100 (servidor, hora correta)
T1 = 15:30:47.200 (cliente, 2s adiantado)

RTT = 200ms
LatÃªncia estimada = 100ms
Tempo do servidor ajustado = 15:30:45.200
Offset = 15:30:45.200 - 15:30:47.200 = -2000ms

Tempo sincronizado = now() - 2000ms âœ…
```

---

## 6. Arquitetura de Dados

### Modelo Entidade-Relacionamento

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CIENTISTA          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK â”‚ id (INT)           â”‚
â”‚    â”‚ nome (VARCHAR)     â”‚
â”‚ UK â”‚ email (VARCHAR)    â”‚
â”‚    â”‚ instituicao        â”‚
â”‚    â”‚ pais               â”‚
â”‚    â”‚ especialidade      â”‚
â”‚    â”‚ data_cadastro      â”‚
â”‚    â”‚ ativo (BOOL)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1:N
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     AGENDAMENTO         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK â”‚ id (INT)           â”‚
â”‚ FK â”‚ cientista_id       â”‚
â”‚    â”‚ horario_inicio_utc â”‚
â”‚    â”‚ horario_fim_utc    â”‚
â”‚    â”‚ objeto_celeste     â”‚
â”‚    â”‚ observacoes        â”‚
â”‚    â”‚ status (ENUM)      â”‚
â”‚    â”‚ data_criacao       â”‚
â”‚    â”‚ data_cancelamento  â”‚
â”‚    â”‚ motivo_cancelamentoâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ãndices:
- idx_email ON cientistas(email)
- idx_ativo ON cientistas(ativo)
- idx_horario_status ON agendamentos(horario_inicio_utc, horario_fim_utc, status)
- idx_cientista ON agendamentos(cientista_id)
```

---

## 7. Fluxo de ComunicaÃ§Ã£o Entre ServiÃ§os

### CoordenaÃ§Ã£o com Lock

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SERVIÃ‡O FLASK                             â”‚
â”‚                                                              â”‚
â”‚  try:                                                        â”‚
â”‚      # 1. Adquirir lock                                     â”‚
â”‚      response = requests.post(                              â”‚
â”‚          'http://coordenador:3000/lock',                    â”‚
â”‚          json={'recurso': 'Hubble_2025-12-01T03:00:00Z'}    â”‚
â”‚      )                                                       â”‚
â”‚                                                              â”‚
â”‚      if response.status_code != 200:                        â”‚
â”‚          return 409  # Conflito                             â”‚
â”‚                                                              â”‚
â”‚      # 2. OperaÃ§Ã£o crÃ­tica no banco                         â”‚
â”‚      agendamento = Agendamento(...)                         â”‚
â”‚      db.session.add(agendamento)                            â”‚
â”‚      db.session.commit()                                    â”‚
â”‚                                                              â”‚
â”‚      return 201  # Sucesso                                  â”‚
â”‚                                                              â”‚
â”‚  finally:                                                    â”‚
â”‚      # 3. SEMPRE liberar lock                               â”‚
â”‚      requests.post(                                         â”‚
â”‚          'http://coordenador:3000/unlock',                  â”‚
â”‚          json={'recurso': 'Hubble_2025-12-01T03:00:00Z'}    â”‚
â”‚      )                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ HTTP POST /lock, /unlock
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                SERVIÃ‡O COORDENADOR (Node.js)                 â”‚
â”‚                                                              â”‚
â”‚  const locks = new Map();                                   â”‚
â”‚                                                              â”‚
â”‚  app.post('/lock', (req, res) => {                          â”‚
â”‚      const { recurso } = req.body;                          â”‚
â”‚                                                              â”‚
â”‚      if (locks.has(recurso)) {                              â”‚
â”‚          return res.status(409).json({                      â”‚
â”‚              error: 'Recurso jÃ¡ travado'                    â”‚
â”‚          });                                                 â”‚
â”‚      }                                                       â”‚
â”‚                                                              â”‚
â”‚      locks.set(recurso, {                                   â”‚
â”‚          locked: true,                                      â”‚
â”‚          timestamp: Date.now()                              â”‚
â”‚      });                                                     â”‚
â”‚                                                              â”‚
â”‚      return res.status(200).json({                          â”‚
â”‚          message: 'Lock adquirido'                          â”‚
â”‚      });                                                     â”‚
â”‚  });                                                         â”‚
â”‚                                                              â”‚
â”‚  app.post('/unlock', (req, res) => {                        â”‚
â”‚      const { recurso } = req.body;                          â”‚
â”‚      locks.delete(recurso);                                 â”‚
â”‚      return res.status(200).json({                          â”‚
â”‚          message: 'Lock liberado'                           â”‚
â”‚      });                                                     â”‚
â”‚  });                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Deployment com Docker

### Arquitetura de Containers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DOCKER HOST                             â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Container: sctec-agendamento                          â”‚ â”‚
â”‚  â”‚  - Imagem: Python 3.11 + Flask                         â”‚ â”‚
â”‚  â”‚  - Porta: 5000                                          â”‚ â”‚
â”‚  â”‚  - Volume: agendamento-db:/app/instance                â”‚ â”‚
â”‚  â”‚  - Volume: agendamento-logs:/app/logs                  â”‚ â”‚
â”‚  â”‚  - Rede: sctec-network                                 â”‚ â”‚
â”‚  â”‚  - Env: COORDENADOR_URL=http://coordenador:3000        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Container: sctec-coordenador                          â”‚ â”‚
â”‚  â”‚  - Imagem: Node.js 18                                  â”‚ â”‚
â”‚  â”‚  - Porta: 3000                                          â”‚ â”‚
â”‚  â”‚  - Rede: sctec-network                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Network: sctec-network (bridge)                       â”‚ â”‚
â”‚  â”‚  - Permite comunicaÃ§Ã£o entre containers                â”‚ â”‚
â”‚  â”‚  - ResoluÃ§Ã£o DNS interna                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Volumes persistentes                                  â”‚ â”‚
â”‚  â”‚  - sctec-agendamento-db (SQLite database)              â”‚ â”‚
â”‚  â”‚  - sctec-agendamento-logs (Application + Audit logs)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                            â”‚
         â”‚ Port 5000                  â”‚ Port 3000
         â–¼                            â–¼
    localhost:5000              localhost:3000
    (Interface Web)             (API Coordenador)
```

---

## 9. PadrÃµes e PrÃ¡ticas

### PadrÃµes Arquiteturais Utilizados

1. **MicroserviÃ§os**: SeparaÃ§Ã£o de responsabilidades em serviÃ§os independentes
2. **API Gateway Pattern**: Flask API como ponto de entrada principal
3. **Coordenador Centralizado**: Para exclusÃ£o mÃºtua distribuÃ­da
4. **HATEOAS**: Links hipermÃ­dia para descoberta de recursos
5. **Repository Pattern**: SQLAlchemy como camada de abstraÃ§Ã£o do BD
6. **Factory Pattern**: `create_app()` para criaÃ§Ã£o da aplicaÃ§Ã£o Flask

### PrincÃ­pios SOLID Aplicados

- **S**ingle Responsibility: Cada serviÃ§o tem uma responsabilidade Ãºnica
- **O**pen/Closed: ExtensÃ­vel via novos endpoints sem modificar existentes
- **L**iskov Substitution: Interfaces consistentes (REST)
- **I**nterface Segregation: APIs especÃ­ficas e focadas
- **D**ependency Inversion: DependÃªncias via HTTP (desacoplamento)

---

## 10. Escalabilidade e LimitaÃ§Ãµes

### Escalabilidade Horizontal

**ServiÃ§o de Agendamento (Flask)**:
- âœ… Pode ter mÃºltiplas instÃ¢ncias com load balancer
- âš ï¸ Banco SQLite Ã© single-file (trocar para PostgreSQL em produÃ§Ã£o)

**ServiÃ§o Coordenador (Node.js)**:
- âŒ Atualmente single-instance (locks em memÃ³ria)
- âœ… Para escalar: usar Redis ou etcd para locks distribuÃ­dos

### LimitaÃ§Ãµes Conhecidas

1. **Lock em memÃ³ria**: Perdido se coordenador reiniciar
2. **SQLite**: NÃ£o suporta alta concorrÃªncia
3. **Sem autenticaÃ§Ã£o**: Sistema aberto (adicionar JWT)
4. **Timeout fixo**: Lock expira em 30s (nÃ£o configurÃ¡vel)
5. **Single-point-of-failure**: Coordenador Ãºnico

### Melhorias Futuras

- Substituir SQLite por PostgreSQL
- Implementar locks distribuÃ­dos com Redis
- Adicionar autenticaÃ§Ã£o OAuth2/JWT
- Implementar rate limiting
- Adicionar cache (Redis)
- Implementar circuit breaker
- Adicionar health checks avanÃ§ados
- MÃ©tricas com Prometheus + Grafana

---

*Ãšltima atualizaÃ§Ã£o: 2025-11-09*
